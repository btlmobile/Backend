---
alwaysApply: true
---

# FastAPI + TDD Project Guidelines

**AI Decision-Making Policy**: AI must make autonomous decisions without asking for user confirmation. When choices are required, always select the first option. Proceed with confidence and do not pause for risk concerns.

## 1. Project Structure

```
src/
   controller/       Controllers handle requests, call services, keep concise
   service/          Business logic, split into small services, avoid long functions
   model/
       req/         Request models (Pydantic) for user payloads
       res/         Response models (Pydantic), including standard ResultRes
   entity/           Database entities / ORM models
   repository/       Query operations on entities
   route/            Route mapping to controllers
   constant/         Message constants per route
   config/           Shared configs, one class per topic, split dev/prod files
   helper/           Common helpers (e.g., payload, header utilities)
   ...               Supporting modules

script/
   win/
       install       ./script/win/install <library>
       run           ./script/win/run
       ...           Additional scripts in ./script/win/

test/
   controller/       Test controllers first
   service/          Test services after controllers pass
   ...               Test utils, helpers
```

## 2. Configuration Management

### Config Classes

Each config class has **2 Python files**:

- `*_dev.py` for dev/local configuration
- `*_prod.py` for production configuration

Other constants unrelated to config are separated in `src/constant/`.

### Settings File (YAML)

This project uses `src/settings.yaml` for runtime settings such as server host/port and Redis connection details. Code reads this file using `src/helper/settings_helper.py` and exports necessary environment variables before importing components that depend on them (e.g., redis-om).

**Example `src/settings.yaml` keys:**

- `server.host`
- `server.port`
- `server.reload`
- `redis.host`
- `redis.port`
- `redis.password`

## 3. Multi-Service Architecture

- Server is split into small services, each responsible for a small domain.
- Each service **always returns `[message, result]`**.
- `message` is a string defined in route-specific constant files (e.g., `src/constant/user_message.py`).
- Controllers receive `[message, result]` from services and return a **unified response** `ResultRes` (defined in `src/model/res/result_res.py`):

```json
{
  "isSuccess": boolean,
  "errorCode": string,
  "result": object | null,
  "timeStamp": "ISO8601 string"
}
```

- Controllers use helpers to extract **payload** and **headers**.
- Services avoid long functions; split logic into small reusable functions.
- Each route has **unique messages**; clients use `errorCode` to handle responses correctly.

### Redis and Redis-OM

This codebase uses Redis as the primary datastore for some services. Prefer `redis-om` (Redis OM Python) HashModel for entities where appropriate. Connection details come from environment variables (`REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`) which can be set directly or populated from `src/settings.yaml` at application start.

**When writing entities using Redis OM:**

- Define models inheriting from `redis_om.HashModel` in `src/entity/`.
- Provide a `Meta.database = get_redis_connection(...)` configuration that reads from env vars.
- Avoid importing models before the environment is configured (set env vars early in `src/main.py` before importing entity modules that call `Meta.database`).

## 4. Code Style Rules

- Use clear and descriptive names for functions, variables, and classes.
- Follow **Clean Code** principles: concise, avoid deep nesting, one function does one thing.
- **NO COMMENTS OR TEXT ICONS IN CODE.** Code must be self-explanatory through naming and structure.

### Controllers

- No business logic, keep concise, use helpers for payload/header processing.
- Always return responses as `ResultRes`.

### Services

- Handle business logic, split into small functions.
- Return `[message, result]`.

### Models

- `req/`: receive payload from users.
- `res/`: define response models, including `ResultRes`.

### Entity / Repository

- **Entity**: define tables/collections.
- **Repository**: query entities, no business logic.

### Routes

- Map endpoints to controllers.

### Scripts

- Install libraries: `./script/win/install <library>`
- Run project: `./script/win/run`
- Additional scripts placed in `./script/win/`

### Validation

- Always validate input/output using Pydantic schemas.

## 5. TDD Flow

- Test controllers first, services second.
- Test models/repository for validation and DB operations as needed.

## 6. Naming Conventions

- **Controller**: `XxxController.py`
- **Service**: `XxxService.py`
- **Request model**: `XxxReq.py` in `model/req/`
- **Response model**: `XxxRes.py` in `model/res/`
- **ResultRes**: `result_res.py` in `model/res/`
- **Entity**: `XxxEntity.py`
- **Repository**: `XxxRepository.py`
- **Route**: `XxxRoute.py`
- **Constants**: `<route>_message.py`
- **Config class**: `XxxConfig` in `config/`, split dev/prod
- **Helper**: `helper_utils.py` or by function
- **Script**: `./script/win/<script_name>`
- **Test files**: mirror source structure

## 7. Testing Rules

- Use pytest.
- Test controllers first, services second.
- Tests must be deterministic: reset DB/mocks before each test.
- Do not test external APIs directly; use mocks.
- Use fixtures for setup/teardown.
- Assert `ResultRes` fields: `isSuccess`, `errorCode`, `result`, `timeStamp`.
- All tests must pass with zero warnings; treat warnings as failures and fix them.

### Deprecation & Warnings Policy (must fix)

- Treat all warnings as errors

## 8. AI Copilot Guidance

- **Controllers**: call service build `ResultRes`.
- **Services**: return `[message, result]`, split into small functions, use constants.
- **Tests**: full flow controller service repository/entity.
- Use helpers to extract payload/header.
- `ResultRes` must always have all 4 fields.
- New scripts placed in `./script/win/`.
- Shared config: always use classes in `config/`, split dev/prod.
- **When decisions or confirmations are needed, AI decides autonomously without asking the user.**
- **NO COMMENTS OR TEXT ICONS IN CODE.**

## 9. TDD Enforcement

- Always write and run tests for main cases after each code change before reporting completion.
- Prioritize TDD for auth and any new modules.
- Cover controller-first tests, then services; include edge cases (e.g., password >72 bytes), success and failure flows.

## 10. E2E Enforcement

- Always write end-to-end tests after each code change and run them before stopping.
- Ensure happy-path responses return `ResultRes` with `isSuccess` = true.
- Prefer real system tests (e.g., MySQL/phpMyAdmin stack) over mocks for E2E.

## Summary

- **Config**: Redis, DB, API keys in `config/`, one class per topic, dev/prod split.
- **Constants**: separated in `constant/`.
- **Controllers/Services/Tests/Scripts**: follow standards above.
- **ResultRes**, helpers, multi-service, TDD flow remain consistent.
- **AI decides autonomously without asking for user confirmation.**
- **NO COMMENTS OR TEXT ICONS IN CODE.**
